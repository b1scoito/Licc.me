const ObjectId = require("mongodb").ObjectId;
const crypto = require("crypto");
const channel = require("class/channel.js");

module.exports = async (session, message) => {
    if (await session.set()) {
        const { guild_id } = message;

        if (await channel.isOwner(guild_id, session.user_id)) {
            const invite = crypto.randomBytes(6).toString("base64").replace(/\+|=|\//, "");
            const db = await require("class/database.js");
            const count = await db.collection("invites").count({ guild_id: ObjectId(guild_id) });

            if (count < 10) {
                try {
                    const result = await db.collection("invites").insertOne({ _id: invite, guild_id: ObjectId(guild_id) });

                    if (result.insertedCount === 1) {
                        return {
                            status: true,
                            invite: invite
                        }
                    } else {
                        return {
                            status: false,
                            error: "Failed to save"
                        }
                    }
                } catch (error) {
                    return {
                        status: false,
                        error: "Failed to create this invite, try again"
                    }
                }
            } else {
                return {
                    status: false,
                    error: "Invite limit reached"
                }
            }
        } else {
            return {
                status: false,
                error: "Missing permissions"
            }
        }
    } else {
        return {
            status: false
        }
    }
}
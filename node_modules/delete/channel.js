const ObjectId = require("mongodb").ObjectId;
const channel = require("class/channel.js");

module.exports = async (session, query) => {
    if (await session.set()) {
        const { guild_id, channel_id } = query;

        if (await channel.isOwner(guild_id, session.user_id)) {
            const db = await require("class/database.js");
            const result = await db.collection("guilds").findOne({ _id: ObjectId(guild_id) }, { projection: { _id: 0, channels: 1 } });

            if (result !== null) {
                if (result.channels[0].toString() !== channel_id) {
                    const promise = await Promise.all([db.collection("guild_channels").deleteOne({ _id: ObjectId(channel_id), guild_id: ObjectId(guild_id) }), db.collection("messages").deleteMany({ channel_id: ObjectId(channel_id) })]);

                    if (promise[0].deletedCount === 1) {
                        await db.collection("guilds").updateOne({ _id: ObjectId(guild_id) }, { $pull: { channels: ObjectId(channel_id) } });

                        return {
                            status: true,
                            type: "GUILD_CHANNEL_DELETE",
                            guild_id: guild_id,
                            channel_id: channel_id
                        }
                    } else {
                        return {
                            status: false,
                            error: "Failed to delete"
                        }
                    }
                } else {
                    return {
                        status: false,
                        error: "Cannot delete main channel"
                    }
                }
            } else {
                return {
                    status: false,
                    error: "Failed to delete"
                }
            }
        } else {
            return {
                status: false,
                error: "Missing permissions"
            }
        }
    } else {
        return {
            status: false
        }
    }
}
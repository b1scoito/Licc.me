const ObjectId = require("mongodb").ObjectId;
const bcrypt = require("bcryptjs");

module.exports = async (session, message) => {
    if (await session.set()) {
        const { current, password, verify } = message;

        if (typeof current === "string" && typeof password === "string" && typeof verify === "string") {
            if (current.length >= 8) {
                if (password.length >= 8) {
                    if (password === verify) {
                        const db = await require("class/database.js");
                        const find = await db.collection("users").findOne({ _id: ObjectId(session.user_id) }, { projection: { _id: 0, password: 1 }});

                        if (await bcrypt.compare(current, find.password)) {
                            const result = await db.collection("users").updateOne({ _id: ObjectId(session.user_id) }, { $set: { password: await bcrypt.hash(password, 10) }});

                            if (result.modifiedCount === 1) {
                                return {
                                    status: true
                                }
                            } else {
                                return {
                                    status: false,
                                    error: "Failed to change your password"
                                }
                            }
                        } else {
                            return {
                                status: false,
                                error: "Wrong password"
                            }
                        }
                    } else {
                        return {
                            status: false,
                            error: "Passwords don't match"
                        }
                    }
                } else {
                    return {
                        status: false,
                        error: "Password must have at least 8 characters"
                    }
                }
            } else {
                return {
                    status: false,
                    error: "Wrong password"
                }
            }
        } else {
            return {
                status: false,
                error: "Missing fields"
            }
        }
    } else {
        return {
            status: false
        }
    }
}
const ObjectId = require("mongodb").ObjectId;
const channel = require("class/channel.js");

module.exports = async (session, query) => {
    if (await session.set()) {
        const { guild_id } = query;

        if (!(await channel.isOwner(guild_id, session.user_id))) {
            const db = await require("class/database.js");
            const result = await db.collection("members").deleteOne({ guild_id: ObjectId(guild_id), member_id: ObjectId(session.user_id) });

            if (result.deletedCount === 1) {
                const find = await db.collection("guilds").findOne({ _id: ObjectId(guild_id) }, { projection: { _id: 0, channels: 1 } });
                const { channels } = find;

                const length = channels.length;
                for (let i = 0; i < length; i++) {
                    channels[i] = channels[i].toString();
                }
                return {
                    status: true,
                    type: "GUILD_DELETE",
                    guild_id: guild_id,
                    channels: channels
                }
            } else {
                return {
                    status: false,
                    error: "Failed to leave"
                }
            }
        } else {
            return {
                status: false,
                error: "Cannot leave this community"
            }
        }
    } else {
        return {
            status: false
        }
    }
}